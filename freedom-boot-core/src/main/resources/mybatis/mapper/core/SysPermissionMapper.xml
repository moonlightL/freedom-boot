<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.extlight.core.mapper.SysPermissionMapper">

    <select id="selectByUserId" parameterType="java.lang.Long" resultType="com.extlight.core.model.SysPermission">
      SELECT
        p.id,
        p.`name`,
        p.`code`,
        p.icon,
        p.type,
        p.pid,
        p.url,
        p.common
      FROM
        t_sys_permission p
      INNER JOIN t_sys_role_permission rp ON p.id = rp.permission_id
      INNER JOIN t_sys_user_role ur ON rp.role_id = ur.role_id
      WHERE
        ur.user_id = #{userId}
      AND p.state = 1
    </select>

  <select id="selectByRoleId" parameterType="java.lang.Long" resultType="com.extlight.core.model.SysPermission">
    SELECT
        p.id,
        p.`name`,
        p.`code`,
        p.icon,
        p.type,
        p.pid,
        p.url,
        p.common
    FROM
        t_sys_permission p
    INNER JOIN t_sys_role_permission rp ON p.id = rp.permission_id
    WHERE
        rp.role_id = #{roleId}
    AND p.state = 1
  </select>

    <select id="selectCommonButtonList" parameterType="java.lang.String" resultType="com.extlight.core.model.SysPermission">
        SELECT
            p.name,
            p.icon,
            p.code
        FROM
            t_sys_permission p
        INNER JOIN (
            SELECT
                id
            FROM
                t_sys_permission
            WHERE
                url = #{url}
        ) a ON p.pid = a.id
        WHERE
            p.type = 3
        AND p.common = 1
        AND p.state = 1
    </select>

    <resultMap id="permissionMap" type="com.extlight.core.model.vo.SysPermissionVO">
        <id property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="icon" column="icon"/>
        <result property="code" column="code"/>
        <collection property="children" column="id" select="com.extlight.core.mapper.SysPermissionMapper.selectByPid">
            <id property="id" column="id"/>
            <result property="name" column="name"/>
            <result property="icon" column="icon"/>
            <result property="code" column="code"/>
        </collection>
    </resultMap>

    <select id="selectHierarchyPermissionList" resultMap="permissionMap">
        SELECT
            p.id,
            p.name,
            p.icon,
            p.code
        FROM
            t_sys_permission p
        WHERE
            p.type = 1
        AND p.state = 1
        ORDER BY p.sort
    </select>


    <select id="selectByPid" parameterType="java.lang.Long" resultType="com.extlight.core.model.vo.SysPermissionVO">
        SELECT
            p.id,
            p.name,
            p.icon,
            p.code
        FROM
            t_sys_permission p
        WHERE
            p.pid = #{id}
        AND p.state = 1
        ORDER BY p.sort
    </select>
    
</mapper>